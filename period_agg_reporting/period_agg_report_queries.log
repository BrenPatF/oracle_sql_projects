
Database             Time                 Version
-------------------- -------------------- ------------------------------
Start: ORCL          28-FEB-2021 14:16:26 Version 19.3.0.0.0


Session altered.

Sales History Records with Running Sums

Product    Month          Value Value to Date     Cost Cost to Date
---------- ----------- -------- ------------- -------- ------------
PROD_ONE   01-Mar-2018    6,448         6,448      317          317
           01-Apr-2018    4,271        10,719      412          729
           01-May-2018    3,588        14,307      593        1,322
           01-Jun-2018    2,621        16,928      464        1,786
           01-Jul-2018    2,487        19,415      524        2,310
           01-Aug-2018    9,916        29,331      679        2,989
           01-Sep-2018    7,241        36,572      795        3,784
           01-Oct-2018    5,367        41,939      453        4,237
           01-Nov-2018    3,196        45,135      194        4,431
           01-Dec-2018    3,726        48,861      534        4,965
           01-Jan-2019    7,553        56,414      126        5,091
           01-Feb-2019    6,197        62,611      942        6,033
           01-Mar-2019    9,794        72,405      520        6,553
           01-Apr-2019    5,995        78,400      639        7,192
           01-May-2019    6,469        84,869      189        7,381
           01-Jun-2019    9,212        94,081      620        8,001
           01-Jul-2019    4,226        98,307      820        8,821
           01-Aug-2019    8,625       106,932      340        9,161
           01-Sep-2019    7,185       114,117      146        9,307
           01-Oct-2019    3,698       117,815      139        9,446
           01-Nov-2019    1,325       119,140      533        9,979
           01-Dec-2019    3,717       122,857      120       10,099
           01-Jan-2020    7,315       130,172      803       10,902
           01-Feb-2020    7,846       138,018      842       11,744
           01-Mar-2020    9,766       147,784      477       12,221
           01-Apr-2020    9,017       156,801      139       12,360
           01-May-2020    4,638       161,439      776       13,136
           01-Jun-2020    4,353       165,792      624       13,760
           01-Jul-2020    7,372       173,164      927       14,687
           01-Aug-2020    9,509       182,673      906       15,593
           01-Sep-2020    6,826       189,499      183       15,776
           01-Oct-2020    9,841       199,340      571       16,347
           01-Nov-2020    3,442       202,782      854       17,201
           01-Dec-2020    9,182       211,964      443       17,644
           01-Jan-2021    8,410       220,374      806       18,450
           01-Feb-2021    4,914       225,288      352       18,802
PROD_TWO   01-Mar-2018    6,274         6,274      644          644
           01-Apr-2018    5,531        11,805      487        1,131
           01-May-2018    8,288        20,093      404        1,535
           01-Jun-2018    7,846        27,939      956        2,491
           01-Jul-2018    8,976        36,915      501        2,992
           01-Aug-2018    6,781        43,696      111        3,103
           01-Sep-2018    8,647        52,343      357        3,460
           01-Oct-2018    2,440        54,783      160        3,620
           01-Nov-2018    7,467        62,250      813        4,433
           01-Dec-2018    2,452        64,702      401        4,834
           01-Jan-2019    2,296        66,998      354        5,188
           01-Feb-2019    6,100        73,098      377        5,565
           01-Mar-2019    3,871        76,969      290        5,855
           01-Apr-2019    4,622        81,591      572        6,427
           01-May-2019    6,094        87,685      276        6,703
           01-Jun-2019    1,945        89,630      604        7,307
           01-Jul-2019    1,215        90,845      455        7,762
           01-Aug-2019    5,260        96,105      293        8,055
           01-Sep-2019    1,798        97,903      220        8,275
           01-Oct-2019    5,801       103,704      635        8,910
           01-Nov-2019    4,278       107,982      629        9,539
           01-Dec-2019    9,163       117,145      547       10,086
           01-Jan-2020    4,399       121,544      228       10,314
           01-Feb-2020    6,310       127,854      991       11,305
           01-Mar-2020    6,675       134,529      163       11,468
           01-Apr-2020    7,437       141,966      971       12,439
           01-May-2020    1,603       143,569      101       12,540
           01-Jun-2020    6,288       149,857      915       13,455
           01-Jul-2020    8,342       158,199      915       14,370
           01-Aug-2020    9,594       167,793      438       14,808
           01-Sep-2020    5,802       173,595      879       15,687
           01-Oct-2020    5,600       179,195      919       16,606
           01-Nov-2020    8,560       187,755      204       16,810
           01-Dec-2020    3,032       190,787      945       17,755
           01-Jan-2021    4,764       195,551      724       18,479
           01-Feb-2021    6,945       202,496      175       18,654

72 rows selected.

  1  SELECT prod_code, month_dt, sales_value, Sum(sales_value) OVER (PARTITION BY prod_code ORDER BY month_dt) value_rsum,
  2  	   sales_cost, Sum(sales_cost) OVER (PARTITION BY prod_code ORDER BY month_dt) cost_rsum
  3    FROM sales_history
  4*  ORDER BY 1, 2
Periods Report by Union of Group Bys

Month       Product    Period             Value     Cost
----------- ---------- --------------- -------- --------
01-Mar-2018 PROD_ONE   P1 - 1 Month       6,448      317
                       P2 - 3 Months      6,448      317
                       P3 - YTD           6,448      317
                       P4 - 1 Year        6,448      317
            PROD_TWO   P1 - 1 Month       6,274      644
                       P2 - 3 Months      6,274      644
                       P3 - YTD           6,274      644
                       P4 - 1 Year        6,274      644
01-Apr-2018 PROD_ONE   P1 - 1 Month       4,271      412
                       P2 - 3 Months     10,719      729
                       P3 - YTD          10,719      729
                       P4 - 1 Year       10,719      729
            PROD_TWO   P1 - 1 Month       5,531      487
                       P2 - 3 Months     11,805    1,131
                       P3 - YTD          11,805    1,131
                       P4 - 1 Year       11,805    1,131
01-May-2018 PROD_ONE   P1 - 1 Month       3,588      593
                       P2 - 3 Months     14,307    1,322
                       P3 - YTD          14,307    1,322
                       P4 - 1 Year       14,307    1,322
            PROD_TWO   P1 - 1 Month       8,288      404
                       P2 - 3 Months     20,093    1,535
                       P3 - YTD          20,093    1,535
                       P4 - 1 Year       20,093    1,535
01-Jun-2018 PROD_ONE   P1 - 1 Month       2,621      464
                       P2 - 3 Months     10,480    1,469
                       P3 - YTD          16,928    1,786
                       P4 - 1 Year       16,928    1,786
            PROD_TWO   P1 - 1 Month       7,846      956
                       P2 - 3 Months     21,665    1,847
                       P3 - YTD          27,939    2,491
                       P4 - 1 Year       27,939    2,491
01-Jul-2018 PROD_ONE   P1 - 1 Month       2,487      524
                       P2 - 3 Months      8,696    1,581
                       P3 - YTD          19,415    2,310
                       P4 - 1 Year       19,415    2,310
            PROD_TWO   P1 - 1 Month       8,976      501
                       P2 - 3 Months     25,110    1,861
                       P3 - YTD          36,915    2,992
                       P4 - 1 Year       36,915    2,992
01-Aug-2018 PROD_ONE   P1 - 1 Month       9,916      679
                       P2 - 3 Months     15,024    1,667
                       P3 - YTD          29,331    2,989
                       P4 - 1 Year       29,331    2,989
            PROD_TWO   P1 - 1 Month       6,781      111
                       P2 - 3 Months     23,603    1,568
                       P3 - YTD          43,696    3,103
                       P4 - 1 Year       43,696    3,103
01-Sep-2018 PROD_ONE   P1 - 1 Month       7,241      795
                       P2 - 3 Months     19,644    1,998
                       P3 - YTD          36,572    3,784
                       P4 - 1 Year       36,572    3,784
            PROD_TWO   P1 - 1 Month       8,647      357
                       P2 - 3 Months     24,404      969
                       P3 - YTD          52,343    3,460
                       P4 - 1 Year       52,343    3,460
01-Oct-2018 PROD_ONE   P1 - 1 Month       5,367      453
                       P2 - 3 Months     22,524    1,927
                       P3 - YTD          41,939    4,237
                       P4 - 1 Year       41,939    4,237
            PROD_TWO   P1 - 1 Month       2,440      160
                       P2 - 3 Months     17,868      628
                       P3 - YTD          54,783    3,620
                       P4 - 1 Year       54,783    3,620
01-Nov-2018 PROD_ONE   P1 - 1 Month       3,196      194
                       P2 - 3 Months     15,804    1,442
                       P3 - YTD          45,135    4,431
                       P4 - 1 Year       45,135    4,431
            PROD_TWO   P1 - 1 Month       7,467      813
                       P2 - 3 Months     18,554    1,330
                       P3 - YTD          62,250    4,433
                       P4 - 1 Year       62,250    4,433
01-Dec-2018 PROD_ONE   P1 - 1 Month       3,726      534
                       P2 - 3 Months     12,289    1,181
                       P3 - YTD          48,861    4,965
                       P4 - 1 Year       48,861    4,965
            PROD_TWO   P1 - 1 Month       2,452      401
                       P2 - 3 Months     12,359    1,374
                       P3 - YTD          64,702    4,834
                       P4 - 1 Year       64,702    4,834
01-Jan-2019 PROD_ONE   P1 - 1 Month       7,553      126
                       P2 - 3 Months     14,475      854
                       P3 - YTD           7,553      126
                       P4 - 1 Year       56,414    5,091
            PROD_TWO   P1 - 1 Month       2,296      354
                       P2 - 3 Months     12,215    1,568
                       P3 - YTD           2,296      354
                       P4 - 1 Year       66,998    5,188
01-Feb-2019 PROD_ONE   P1 - 1 Month       6,197      942
                       P2 - 3 Months     17,476    1,602
                       P3 - YTD          13,750    1,068
                       P4 - 1 Year       62,611    6,033
            PROD_TWO   P1 - 1 Month       6,100      377
                       P2 - 3 Months     10,848    1,132
                       P3 - YTD           8,396      731
                       P4 - 1 Year       73,098    5,565
01-Mar-2019 PROD_ONE   P1 - 1 Month       9,794      520
                       P2 - 3 Months     23,544    1,588
                       P3 - YTD          23,544    1,588
                       P4 - 1 Year       65,957    6,236
            PROD_TWO   P1 - 1 Month       3,871      290
                       P2 - 3 Months     12,267    1,021
                       P3 - YTD          12,267    1,021
                       P4 - 1 Year       70,695    5,211
01-Apr-2019 PROD_ONE   P1 - 1 Month       5,995      639
                       P2 - 3 Months     21,986    2,101
                       P3 - YTD          29,539    2,227
                       P4 - 1 Year       67,681    6,463
            PROD_TWO   P1 - 1 Month       4,622      572
                       P2 - 3 Months     14,593    1,239
                       P3 - YTD          16,889    1,593
                       P4 - 1 Year       69,786    5,296
01-May-2019 PROD_ONE   P1 - 1 Month       6,469      189
                       P2 - 3 Months     22,258    1,348
                       P3 - YTD          36,008    2,416
                       P4 - 1 Year       70,562    6,059
            PROD_TWO   P1 - 1 Month       6,094      276
                       P2 - 3 Months     14,587    1,138
                       P3 - YTD          22,983    1,869
                       P4 - 1 Year       67,592    5,168
01-Jun-2019 PROD_ONE   P1 - 1 Month       9,212      620
                       P2 - 3 Months     21,676    1,448
                       P3 - YTD          45,220    3,036
                       P4 - 1 Year       77,153    6,215
            PROD_TWO   P1 - 1 Month       1,945      604
                       P2 - 3 Months     12,661    1,452
                       P3 - YTD          24,928    2,473
                       P4 - 1 Year       61,691    4,816
01-Jul-2019 PROD_ONE   P1 - 1 Month       4,226      820
                       P2 - 3 Months     19,907    1,629
                       P3 - YTD          49,446    3,856
                       P4 - 1 Year       78,892    6,511
            PROD_TWO   P1 - 1 Month       1,215      455
                       P2 - 3 Months      9,254    1,335
                       P3 - YTD          26,143    2,928
                       P4 - 1 Year       53,930    4,770
01-Aug-2019 PROD_ONE   P1 - 1 Month       8,625      340
                       P2 - 3 Months     22,063    1,780
                       P3 - YTD          58,071    4,196
                       P4 - 1 Year       77,601    6,172
            PROD_TWO   P1 - 1 Month       5,260      293
                       P2 - 3 Months      8,420    1,352
                       P3 - YTD          31,403    3,221
                       P4 - 1 Year       52,409    4,952
01-Sep-2019 PROD_ONE   P1 - 1 Month       7,185      146
                       P2 - 3 Months     20,036    1,306
                       P3 - YTD          65,256    4,342
                       P4 - 1 Year       77,545    5,523
            PROD_TWO   P1 - 1 Month       1,798      220
                       P2 - 3 Months      8,273      968
                       P3 - YTD          33,201    3,441
                       P4 - 1 Year       45,560    4,815
01-Oct-2019 PROD_ONE   P1 - 1 Month       3,698      139
                       P2 - 3 Months     19,508      625
                       P3 - YTD          68,954    4,481
                       P4 - 1 Year       75,876    5,209
            PROD_TWO   P1 - 1 Month       5,801      635
                       P2 - 3 Months     12,859    1,148
                       P3 - YTD          39,002    4,076
                       P4 - 1 Year       48,921    5,290
01-Nov-2019 PROD_ONE   P1 - 1 Month       1,325      533
                       P2 - 3 Months     12,208      818
                       P3 - YTD          70,279    5,014
                       P4 - 1 Year       74,005    5,548
            PROD_TWO   P1 - 1 Month       4,278      629
                       P2 - 3 Months     11,877    1,484
                       P3 - YTD          43,280    4,705
                       P4 - 1 Year       45,732    5,106
01-Dec-2019 PROD_ONE   P1 - 1 Month       3,717      120
                       P2 - 3 Months      8,740      792
                       P3 - YTD          73,996    5,134
                       P4 - 1 Year       73,996    5,134
            PROD_TWO   P1 - 1 Month       9,163      547
                       P2 - 3 Months     19,242    1,811
                       P3 - YTD          52,443    5,252
                       P4 - 1 Year       52,443    5,252
01-Jan-2020 PROD_ONE   P1 - 1 Month       7,315      803
                       P2 - 3 Months     12,357    1,456
                       P3 - YTD           7,315      803
                       P4 - 1 Year       73,758    5,811
            PROD_TWO   P1 - 1 Month       4,399      228
                       P2 - 3 Months     17,840    1,404
                       P3 - YTD           4,399      228
                       P4 - 1 Year       54,546    5,126
01-Feb-2020 PROD_ONE   P1 - 1 Month       7,846      842
                       P2 - 3 Months     18,878    1,765
                       P3 - YTD          15,161    1,645
                       P4 - 1 Year       75,407    5,711
            PROD_TWO   P1 - 1 Month       6,310      991
                       P2 - 3 Months     19,872    1,766
                       P3 - YTD          10,709    1,219
                       P4 - 1 Year       54,756    5,740
01-Mar-2020 PROD_ONE   P1 - 1 Month       9,766      477
                       P2 - 3 Months     24,927    2,122
                       P3 - YTD          24,927    2,122
                       P4 - 1 Year       75,379    5,668
            PROD_TWO   P1 - 1 Month       6,675      163
                       P2 - 3 Months     17,384    1,382
                       P3 - YTD          17,384    1,382
                       P4 - 1 Year       57,560    5,613
01-Apr-2020 PROD_ONE   P1 - 1 Month       9,017      139
                       P2 - 3 Months     26,629    1,458
                       P3 - YTD          33,944    2,261
                       P4 - 1 Year       78,401    5,168
            PROD_TWO   P1 - 1 Month       7,437      971
                       P2 - 3 Months     20,422    2,125
                       P3 - YTD          24,821    2,353
                       P4 - 1 Year       60,375    6,012
01-May-2020 PROD_ONE   P1 - 1 Month       4,638      776
                       P2 - 3 Months     23,421    1,392
                       P3 - YTD          38,582    3,037
                       P4 - 1 Year       76,570    5,755
            PROD_TWO   P1 - 1 Month       1,603      101
                       P2 - 3 Months     15,715    1,235
                       P3 - YTD          26,424    2,454
                       P4 - 1 Year       55,884    5,837
01-Jun-2020 PROD_ONE   P1 - 1 Month       4,353      624
                       P2 - 3 Months     18,008    1,539
                       P3 - YTD          42,935    3,661
                       P4 - 1 Year       71,711    5,759
            PROD_TWO   P1 - 1 Month       6,288      915
                       P2 - 3 Months     15,328    1,987
                       P3 - YTD          32,712    3,369
                       P4 - 1 Year       60,227    6,148
01-Jul-2020 PROD_ONE   P1 - 1 Month       7,372      927
                       P2 - 3 Months     16,363    2,327
                       P3 - YTD          50,307    4,588
                       P4 - 1 Year       74,857    5,866
            PROD_TWO   P1 - 1 Month       8,342      915
                       P2 - 3 Months     16,233    1,931
                       P3 - YTD          41,054    4,284
                       P4 - 1 Year       67,354    6,608
01-Aug-2020 PROD_ONE   P1 - 1 Month       9,509      906
                       P2 - 3 Months     21,234    2,457
                       P3 - YTD          59,816    5,494
                       P4 - 1 Year       75,741    6,432
            PROD_TWO   P1 - 1 Month       9,594      438
                       P2 - 3 Months     24,224    2,268
                       P3 - YTD          50,648    4,722
                       P4 - 1 Year       71,688    6,753
01-Sep-2020 PROD_ONE   P1 - 1 Month       6,826      183
                       P2 - 3 Months     23,707    2,016
                       P3 - YTD          66,642    5,677
                       P4 - 1 Year       75,382    6,469
            PROD_TWO   P1 - 1 Month       5,802      879
                       P2 - 3 Months     23,738    2,232
                       P3 - YTD          56,450    5,601
                       P4 - 1 Year       75,692    7,412
01-Oct-2020 PROD_ONE   P1 - 1 Month       9,841      571
                       P2 - 3 Months     26,176    1,660
                       P3 - YTD          76,483    6,248
                       P4 - 1 Year       81,525    6,901
            PROD_TWO   P1 - 1 Month       5,600      919
                       P2 - 3 Months     20,996    2,236
                       P3 - YTD          62,050    6,520
                       P4 - 1 Year       75,491    7,696
01-Nov-2020 PROD_ONE   P1 - 1 Month       3,442      854
                       P2 - 3 Months     20,109    1,608
                       P3 - YTD          79,925    7,102
                       P4 - 1 Year       83,642    7,222
            PROD_TWO   P1 - 1 Month       8,560      204
                       P2 - 3 Months     19,962    2,002
                       P3 - YTD          70,610    6,724
                       P4 - 1 Year       79,773    7,271
01-Dec-2020 PROD_ONE   P1 - 1 Month       9,182      443
                       P2 - 3 Months     22,465    1,868
                       P3 - YTD          89,107    7,545
                       P4 - 1 Year       89,107    7,545
            PROD_TWO   P1 - 1 Month       3,032      945
                       P2 - 3 Months     17,192    2,068
                       P3 - YTD          73,642    7,669
                       P4 - 1 Year       73,642    7,669
01-Jan-2021 PROD_ONE   P1 - 1 Month       8,410      806
                       P2 - 3 Months     21,034    2,103
                       P3 - YTD           8,410      806
                       P4 - 1 Year       90,202    7,548
            PROD_TWO   P1 - 1 Month       4,764      724
                       P2 - 3 Months     16,356    1,873
                       P3 - YTD           4,764      724
                       P4 - 1 Year       74,007    8,165
01-Feb-2021 PROD_ONE   P1 - 1 Month       4,914      352
                       P2 - 3 Months     22,506    1,601
                       P3 - YTD          13,324    1,158
                       P4 - 1 Year       87,270    7,058
            PROD_TWO   P1 - 1 Month       6,945      175
                       P2 - 3 Months     14,741    1,844
                       P3 - YTD          11,709      899
                       P4 - 1 Year       74,642    7,349

288 rows selected.

  1  SELECT /*+ gather_plan_statistics XPLAN_MARKER_UGB */
  2  	   month_dt, prod_code, 'P1 - 1 Month' per_tp, sales_value, sales_cost
  3    FROM sales_history
  4   UNION ALL
  5  SELECT drv.month_dt, drv.prod_code, 'P2 - 3 Months', Sum(msr.sales_value), Sum(msr.sales_cost)
  6    FROM sales_history drv
  7    JOIN sales_history msr
  8  	ON msr.prod_code = drv.prod_code
  9     AND msr.month_dt BETWEEN Add_Months (drv.month_dt, -2) AND drv.month_dt
 10   GROUP BY drv.prod_code, drv.month_dt
 11   UNION ALL
 12  SELECT drv.month_dt, drv.prod_code, 'P3 - YTD', Sum(msr.sales_value), Sum(msr.sales_cost)
 13    FROM sales_history drv
 14    JOIN sales_history msr
 15  	ON msr.prod_code = drv.prod_code
 16     AND msr.month_dt BETWEEN Trunc(drv.month_dt, 'YEAR') AND drv.month_dt
 17   GROUP BY drv.prod_code, drv.month_dt
 18   UNION ALL
 19  SELECT drv.month_dt, drv.prod_code, 'P4 - 1 Year', Sum(msr.sales_value), Sum(msr.sales_cost)
 20    FROM sales_history drv
 21    JOIN sales_history msr
 22  	ON msr.prod_code = drv.prod_code
 23     AND msr.month_dt BETWEEN Add_Months (drv.month_dt, -11) AND drv.month_dt
 24   GROUP BY drv.prod_code, drv.month_dt
 25*  ORDER BY 1, 2, 3
Report by Analytic Aggregation

Month       Product    Period             Value     Cost
----------- ---------- --------------- -------- --------
01-Mar-2018 PROD_ONE   P1 - 1 Month       6,448      317
                       P2 - 3 Months      6,448      317
                       P3 - YTD           6,448      317
                       P4 - 1 Year        6,448      317
            PROD_TWO   P1 - 1 Month       6,274      644
                       P2 - 3 Months      6,274      644
                       P3 - YTD           6,274      644
                       P4 - 1 Year        6,274      644
01-Apr-2018 PROD_ONE   P1 - 1 Month       4,271      412
                       P2 - 3 Months     10,719      729
                       P3 - YTD          10,719      729
                       P4 - 1 Year       10,719      729
            PROD_TWO   P1 - 1 Month       5,531      487
                       P2 - 3 Months     11,805    1,131
                       P3 - YTD          11,805    1,131
                       P4 - 1 Year       11,805    1,131
01-May-2018 PROD_ONE   P1 - 1 Month       3,588      593
                       P2 - 3 Months     14,307    1,322
                       P3 - YTD          14,307    1,322
                       P4 - 1 Year       14,307    1,322
            PROD_TWO   P1 - 1 Month       8,288      404
                       P2 - 3 Months     20,093    1,535
                       P3 - YTD          20,093    1,535
                       P4 - 1 Year       20,093    1,535
01-Jun-2018 PROD_ONE   P1 - 1 Month       2,621      464
                       P2 - 3 Months     10,480    1,469
                       P3 - YTD          16,928    1,786
                       P4 - 1 Year       16,928    1,786
            PROD_TWO   P1 - 1 Month       7,846      956
                       P2 - 3 Months     21,665    1,847
                       P3 - YTD          27,939    2,491
                       P4 - 1 Year       27,939    2,491
01-Jul-2018 PROD_ONE   P1 - 1 Month       2,487      524
                       P2 - 3 Months      8,696    1,581
                       P3 - YTD          19,415    2,310
                       P4 - 1 Year       19,415    2,310
            PROD_TWO   P1 - 1 Month       8,976      501
                       P2 - 3 Months     25,110    1,861
                       P3 - YTD          36,915    2,992
                       P4 - 1 Year       36,915    2,992
01-Aug-2018 PROD_ONE   P1 - 1 Month       9,916      679
                       P2 - 3 Months     15,024    1,667
                       P3 - YTD          29,331    2,989
                       P4 - 1 Year       29,331    2,989
            PROD_TWO   P1 - 1 Month       6,781      111
                       P2 - 3 Months     23,603    1,568
                       P3 - YTD          43,696    3,103
                       P4 - 1 Year       43,696    3,103
01-Sep-2018 PROD_ONE   P1 - 1 Month       7,241      795
                       P2 - 3 Months     19,644    1,998
                       P3 - YTD          36,572    3,784
                       P4 - 1 Year       36,572    3,784
            PROD_TWO   P1 - 1 Month       8,647      357
                       P2 - 3 Months     24,404      969
                       P3 - YTD          52,343    3,460
                       P4 - 1 Year       52,343    3,460
01-Oct-2018 PROD_ONE   P1 - 1 Month       5,367      453
                       P2 - 3 Months     22,524    1,927
                       P3 - YTD          41,939    4,237
                       P4 - 1 Year       41,939    4,237
            PROD_TWO   P1 - 1 Month       2,440      160
                       P2 - 3 Months     17,868      628
                       P3 - YTD          54,783    3,620
                       P4 - 1 Year       54,783    3,620
01-Nov-2018 PROD_ONE   P1 - 1 Month       3,196      194
                       P2 - 3 Months     15,804    1,442
                       P3 - YTD          45,135    4,431
                       P4 - 1 Year       45,135    4,431
            PROD_TWO   P1 - 1 Month       7,467      813
                       P2 - 3 Months     18,554    1,330
                       P3 - YTD          62,250    4,433
                       P4 - 1 Year       62,250    4,433
01-Dec-2018 PROD_ONE   P1 - 1 Month       3,726      534
                       P2 - 3 Months     12,289    1,181
                       P3 - YTD          48,861    4,965
                       P4 - 1 Year       48,861    4,965
            PROD_TWO   P1 - 1 Month       2,452      401
                       P2 - 3 Months     12,359    1,374
                       P3 - YTD          64,702    4,834
                       P4 - 1 Year       64,702    4,834
01-Jan-2019 PROD_ONE   P1 - 1 Month       7,553      126
                       P2 - 3 Months     14,475      854
                       P3 - YTD           7,553      126
                       P4 - 1 Year       56,414    5,091
            PROD_TWO   P1 - 1 Month       2,296      354
                       P2 - 3 Months     12,215    1,568
                       P3 - YTD           2,296      354
                       P4 - 1 Year       66,998    5,188
01-Feb-2019 PROD_ONE   P1 - 1 Month       6,197      942
                       P2 - 3 Months     17,476    1,602
                       P3 - YTD          13,750    1,068
                       P4 - 1 Year       62,611    6,033
            PROD_TWO   P1 - 1 Month       6,100      377
                       P2 - 3 Months     10,848    1,132
                       P3 - YTD           8,396      731
                       P4 - 1 Year       73,098    5,565
01-Mar-2019 PROD_ONE   P1 - 1 Month       9,794      520
                       P2 - 3 Months     23,544    1,588
                       P3 - YTD          23,544    1,588
                       P4 - 1 Year       65,957    6,236
            PROD_TWO   P1 - 1 Month       3,871      290
                       P2 - 3 Months     12,267    1,021
                       P3 - YTD          12,267    1,021
                       P4 - 1 Year       70,695    5,211
01-Apr-2019 PROD_ONE   P1 - 1 Month       5,995      639
                       P2 - 3 Months     21,986    2,101
                       P3 - YTD          29,539    2,227
                       P4 - 1 Year       67,681    6,463
            PROD_TWO   P1 - 1 Month       4,622      572
                       P2 - 3 Months     14,593    1,239
                       P3 - YTD          16,889    1,593
                       P4 - 1 Year       69,786    5,296
01-May-2019 PROD_ONE   P1 - 1 Month       6,469      189
                       P2 - 3 Months     22,258    1,348
                       P3 - YTD          36,008    2,416
                       P4 - 1 Year       70,562    6,059
            PROD_TWO   P1 - 1 Month       6,094      276
                       P2 - 3 Months     14,587    1,138
                       P3 - YTD          22,983    1,869
                       P4 - 1 Year       67,592    5,168
01-Jun-2019 PROD_ONE   P1 - 1 Month       9,212      620
                       P2 - 3 Months     21,676    1,448
                       P3 - YTD          45,220    3,036
                       P4 - 1 Year       77,153    6,215
            PROD_TWO   P1 - 1 Month       1,945      604
                       P2 - 3 Months     12,661    1,452
                       P3 - YTD          24,928    2,473
                       P4 - 1 Year       61,691    4,816
01-Jul-2019 PROD_ONE   P1 - 1 Month       4,226      820
                       P2 - 3 Months     19,907    1,629
                       P3 - YTD          49,446    3,856
                       P4 - 1 Year       78,892    6,511
            PROD_TWO   P1 - 1 Month       1,215      455
                       P2 - 3 Months      9,254    1,335
                       P3 - YTD          26,143    2,928
                       P4 - 1 Year       53,930    4,770
01-Aug-2019 PROD_ONE   P1 - 1 Month       8,625      340
                       P2 - 3 Months     22,063    1,780
                       P3 - YTD          58,071    4,196
                       P4 - 1 Year       77,601    6,172
            PROD_TWO   P1 - 1 Month       5,260      293
                       P2 - 3 Months      8,420    1,352
                       P3 - YTD          31,403    3,221
                       P4 - 1 Year       52,409    4,952
01-Sep-2019 PROD_ONE   P1 - 1 Month       7,185      146
                       P2 - 3 Months     20,036    1,306
                       P3 - YTD          65,256    4,342
                       P4 - 1 Year       77,545    5,523
            PROD_TWO   P1 - 1 Month       1,798      220
                       P2 - 3 Months      8,273      968
                       P3 - YTD          33,201    3,441
                       P4 - 1 Year       45,560    4,815
01-Oct-2019 PROD_ONE   P1 - 1 Month       3,698      139
                       P2 - 3 Months     19,508      625
                       P3 - YTD          68,954    4,481
                       P4 - 1 Year       75,876    5,209
            PROD_TWO   P1 - 1 Month       5,801      635
                       P2 - 3 Months     12,859    1,148
                       P3 - YTD          39,002    4,076
                       P4 - 1 Year       48,921    5,290
01-Nov-2019 PROD_ONE   P1 - 1 Month       1,325      533
                       P2 - 3 Months     12,208      818
                       P3 - YTD          70,279    5,014
                       P4 - 1 Year       74,005    5,548
            PROD_TWO   P1 - 1 Month       4,278      629
                       P2 - 3 Months     11,877    1,484
                       P3 - YTD          43,280    4,705
                       P4 - 1 Year       45,732    5,106
01-Dec-2019 PROD_ONE   P1 - 1 Month       3,717      120
                       P2 - 3 Months      8,740      792
                       P3 - YTD          73,996    5,134
                       P4 - 1 Year       73,996    5,134
            PROD_TWO   P1 - 1 Month       9,163      547
                       P2 - 3 Months     19,242    1,811
                       P3 - YTD          52,443    5,252
                       P4 - 1 Year       52,443    5,252
01-Jan-2020 PROD_ONE   P1 - 1 Month       7,315      803
                       P2 - 3 Months     12,357    1,456
                       P3 - YTD           7,315      803
                       P4 - 1 Year       73,758    5,811
            PROD_TWO   P1 - 1 Month       4,399      228
                       P2 - 3 Months     17,840    1,404
                       P3 - YTD           4,399      228
                       P4 - 1 Year       54,546    5,126
01-Feb-2020 PROD_ONE   P1 - 1 Month       7,846      842
                       P2 - 3 Months     18,878    1,765
                       P3 - YTD          15,161    1,645
                       P4 - 1 Year       75,407    5,711
            PROD_TWO   P1 - 1 Month       6,310      991
                       P2 - 3 Months     19,872    1,766
                       P3 - YTD          10,709    1,219
                       P4 - 1 Year       54,756    5,740
01-Mar-2020 PROD_ONE   P1 - 1 Month       9,766      477
                       P2 - 3 Months     24,927    2,122
                       P3 - YTD          24,927    2,122
                       P4 - 1 Year       75,379    5,668
            PROD_TWO   P1 - 1 Month       6,675      163
                       P2 - 3 Months     17,384    1,382
                       P3 - YTD          17,384    1,382
                       P4 - 1 Year       57,560    5,613
01-Apr-2020 PROD_ONE   P1 - 1 Month       9,017      139
                       P2 - 3 Months     26,629    1,458
                       P3 - YTD          33,944    2,261
                       P4 - 1 Year       78,401    5,168
            PROD_TWO   P1 - 1 Month       7,437      971
                       P2 - 3 Months     20,422    2,125
                       P3 - YTD          24,821    2,353
                       P4 - 1 Year       60,375    6,012
01-May-2020 PROD_ONE   P1 - 1 Month       4,638      776
                       P2 - 3 Months     23,421    1,392
                       P3 - YTD          38,582    3,037
                       P4 - 1 Year       76,570    5,755
            PROD_TWO   P1 - 1 Month       1,603      101
                       P2 - 3 Months     15,715    1,235
                       P3 - YTD          26,424    2,454
                       P4 - 1 Year       55,884    5,837
01-Jun-2020 PROD_ONE   P1 - 1 Month       4,353      624
                       P2 - 3 Months     18,008    1,539
                       P3 - YTD          42,935    3,661
                       P4 - 1 Year       71,711    5,759
            PROD_TWO   P1 - 1 Month       6,288      915
                       P2 - 3 Months     15,328    1,987
                       P3 - YTD          32,712    3,369
                       P4 - 1 Year       60,227    6,148
01-Jul-2020 PROD_ONE   P1 - 1 Month       7,372      927
                       P2 - 3 Months     16,363    2,327
                       P3 - YTD          50,307    4,588
                       P4 - 1 Year       74,857    5,866
            PROD_TWO   P1 - 1 Month       8,342      915
                       P2 - 3 Months     16,233    1,931
                       P3 - YTD          41,054    4,284
                       P4 - 1 Year       67,354    6,608
01-Aug-2020 PROD_ONE   P1 - 1 Month       9,509      906
                       P2 - 3 Months     21,234    2,457
                       P3 - YTD          59,816    5,494
                       P4 - 1 Year       75,741    6,432
            PROD_TWO   P1 - 1 Month       9,594      438
                       P2 - 3 Months     24,224    2,268
                       P3 - YTD          50,648    4,722
                       P4 - 1 Year       71,688    6,753
01-Sep-2020 PROD_ONE   P1 - 1 Month       6,826      183
                       P2 - 3 Months     23,707    2,016
                       P3 - YTD          66,642    5,677
                       P4 - 1 Year       75,382    6,469
            PROD_TWO   P1 - 1 Month       5,802      879
                       P2 - 3 Months     23,738    2,232
                       P3 - YTD          56,450    5,601
                       P4 - 1 Year       75,692    7,412
01-Oct-2020 PROD_ONE   P1 - 1 Month       9,841      571
                       P2 - 3 Months     26,176    1,660
                       P3 - YTD          76,483    6,248
                       P4 - 1 Year       81,525    6,901
            PROD_TWO   P1 - 1 Month       5,600      919
                       P2 - 3 Months     20,996    2,236
                       P3 - YTD          62,050    6,520
                       P4 - 1 Year       75,491    7,696
01-Nov-2020 PROD_ONE   P1 - 1 Month       3,442      854
                       P2 - 3 Months     20,109    1,608
                       P3 - YTD          79,925    7,102
                       P4 - 1 Year       83,642    7,222
            PROD_TWO   P1 - 1 Month       8,560      204
                       P2 - 3 Months     19,962    2,002
                       P3 - YTD          70,610    6,724
                       P4 - 1 Year       79,773    7,271
01-Dec-2020 PROD_ONE   P1 - 1 Month       9,182      443
                       P2 - 3 Months     22,465    1,868
                       P3 - YTD          89,107    7,545
                       P4 - 1 Year       89,107    7,545
            PROD_TWO   P1 - 1 Month       3,032      945
                       P2 - 3 Months     17,192    2,068
                       P3 - YTD          73,642    7,669
                       P4 - 1 Year       73,642    7,669
01-Jan-2021 PROD_ONE   P1 - 1 Month       8,410      806
                       P2 - 3 Months     21,034    2,103
                       P3 - YTD           8,410      806
                       P4 - 1 Year       90,202    7,548
            PROD_TWO   P1 - 1 Month       4,764      724
                       P2 - 3 Months     16,356    1,873
                       P3 - YTD           4,764      724
                       P4 - 1 Year       74,007    8,165
01-Feb-2021 PROD_ONE   P1 - 1 Month       4,914      352
                       P2 - 3 Months     22,506    1,601
                       P3 - YTD          13,324    1,158
                       P4 - 1 Year       87,270    7,058
            PROD_TWO   P1 - 1 Month       6,945      175
                       P2 - 3 Months     14,741    1,844
                       P3 - YTD          11,709      899
                       P4 - 1 Year       74,642    7,349

288 rows selected.

  1  WITH period_aggs AS (
  2  	SELECT /*+ gather_plan_statistics XPLAN_MARKER_AAG */
  3  		   month_dt, prod_code, sales_value,
  4  		   Sum(sales_value) OVER (PARTITION BY prod_code ORDER BY month_dt
  5  								  RANGE BETWEEN INTERVAL '2' MONTH PRECEDING AND CURRENT ROW) 		sales_value_3m,
  6  		   Sum(sales_value) OVER (PARTITION BY prod_code, Trunc(month_dt, 'YEAR') ORDER BY month_dt
  7  								  RANGE BETWEEN INTERVAL '11' MONTH PRECEDING AND CURRENT ROW) 		sales_value_ytd,
  8  		   Sum(sales_value) OVER (PARTITION BY prod_code ORDER BY month_dt
  9  								  RANGE BETWEEN INTERVAL '11' MONTH PRECEDING AND CURRENT ROW) 		sales_value_1y,
 10  		   sales_cost,
 11  		   Sum(sales_cost) OVER (PARTITION BY prod_code ORDER BY month_dt
 12  								  RANGE BETWEEN INTERVAL '2' MONTH PRECEDING AND CURRENT ROW) 		sales_cost_3m,
 13  		   Sum(sales_cost) OVER (PARTITION BY prod_code, Trunc(month_dt, 'YEAR') ORDER BY month_dt
 14  								  RANGE BETWEEN INTERVAL '11' MONTH PRECEDING AND CURRENT ROW) 		sales_cost_ytd,
 15  		   Sum(sales_cost) OVER (PARTITION BY prod_code ORDER BY month_dt
 16  								  RANGE BETWEEN INTERVAL '11' MONTH PRECEDING AND CURRENT ROW) 		sales_cost_1y
 17  	  FROM sales_history
 18  )
 19  SELECT *
 20    FROM period_aggs
 21  UNPIVOT (
 22  		(sales_value, sales_cost)
 23  		FOR per_tp IN (
 24  			(sales_value, sales_cost) 			AS 'P1 - 1 Month',
 25  			(sales_value_3m, sales_cost_3m) 	AS 'P2 - 3 Months',
 26  			(sales_value_ytd, sales_cost_ytd) 	AS 'P3 - YTD',
 27  			(sales_value_1y, sales_cost_1y) 	AS 'P4 - 1 Year'
 28  		)
 29  )
 30*  ORDER BY 1, 2, 3
Report by Single Group By with CASE Expressions

Month       Product    Period             Value     Cost
----------- ---------- --------------- -------- --------
01-Mar-2018 PROD_ONE   P1 - 1 Month       6,448      317
                       P2 - 3 Months      6,448      317
                       P3 - YTD           6,448      317
                       P4 - 1 Year        6,448      317
            PROD_TWO   P1 - 1 Month       6,274      644
                       P2 - 3 Months      6,274      644
                       P3 - YTD           6,274      644
                       P4 - 1 Year        6,274      644
01-Apr-2018 PROD_ONE   P1 - 1 Month       4,271      412
                       P2 - 3 Months     10,719      729
                       P3 - YTD          10,719      729
                       P4 - 1 Year       10,719      729
            PROD_TWO   P1 - 1 Month       5,531      487
                       P2 - 3 Months     11,805    1,131
                       P3 - YTD          11,805    1,131
                       P4 - 1 Year       11,805    1,131
01-May-2018 PROD_ONE   P1 - 1 Month       3,588      593
                       P2 - 3 Months     14,307    1,322
                       P3 - YTD          14,307    1,322
                       P4 - 1 Year       14,307    1,322
            PROD_TWO   P1 - 1 Month       8,288      404
                       P2 - 3 Months     20,093    1,535
                       P3 - YTD          20,093    1,535
                       P4 - 1 Year       20,093    1,535
01-Jun-2018 PROD_ONE   P1 - 1 Month       2,621      464
                       P2 - 3 Months     10,480    1,469
                       P3 - YTD          16,928    1,786
                       P4 - 1 Year       16,928    1,786
            PROD_TWO   P1 - 1 Month       7,846      956
                       P2 - 3 Months     21,665    1,847
                       P3 - YTD          27,939    2,491
                       P4 - 1 Year       27,939    2,491
01-Jul-2018 PROD_ONE   P1 - 1 Month       2,487      524
                       P2 - 3 Months      8,696    1,581
                       P3 - YTD          19,415    2,310
                       P4 - 1 Year       19,415    2,310
            PROD_TWO   P1 - 1 Month       8,976      501
                       P2 - 3 Months     25,110    1,861
                       P3 - YTD          36,915    2,992
                       P4 - 1 Year       36,915    2,992
01-Aug-2018 PROD_ONE   P1 - 1 Month       9,916      679
                       P2 - 3 Months     15,024    1,667
                       P3 - YTD          29,331    2,989
                       P4 - 1 Year       29,331    2,989
            PROD_TWO   P1 - 1 Month       6,781      111
                       P2 - 3 Months     23,603    1,568
                       P3 - YTD          43,696    3,103
                       P4 - 1 Year       43,696    3,103
01-Sep-2018 PROD_ONE   P1 - 1 Month       7,241      795
                       P2 - 3 Months     19,644    1,998
                       P3 - YTD          36,572    3,784
                       P4 - 1 Year       36,572    3,784
            PROD_TWO   P1 - 1 Month       8,647      357
                       P2 - 3 Months     24,404      969
                       P3 - YTD          52,343    3,460
                       P4 - 1 Year       52,343    3,460
01-Oct-2018 PROD_ONE   P1 - 1 Month       5,367      453
                       P2 - 3 Months     22,524    1,927
                       P3 - YTD          41,939    4,237
                       P4 - 1 Year       41,939    4,237
            PROD_TWO   P1 - 1 Month       2,440      160
                       P2 - 3 Months     17,868      628
                       P3 - YTD          54,783    3,620
                       P4 - 1 Year       54,783    3,620
01-Nov-2018 PROD_ONE   P1 - 1 Month       3,196      194
                       P2 - 3 Months     15,804    1,442
                       P3 - YTD          45,135    4,431
                       P4 - 1 Year       45,135    4,431
            PROD_TWO   P1 - 1 Month       7,467      813
                       P2 - 3 Months     18,554    1,330
                       P3 - YTD          62,250    4,433
                       P4 - 1 Year       62,250    4,433
01-Dec-2018 PROD_ONE   P1 - 1 Month       3,726      534
                       P2 - 3 Months     12,289    1,181
                       P3 - YTD          48,861    4,965
                       P4 - 1 Year       48,861    4,965
            PROD_TWO   P1 - 1 Month       2,452      401
                       P2 - 3 Months     12,359    1,374
                       P3 - YTD          64,702    4,834
                       P4 - 1 Year       64,702    4,834
01-Jan-2019 PROD_ONE   P1 - 1 Month       7,553      126
                       P2 - 3 Months     14,475      854
                       P3 - YTD           7,553      126
                       P4 - 1 Year       56,414    5,091
            PROD_TWO   P1 - 1 Month       2,296      354
                       P2 - 3 Months     12,215    1,568
                       P3 - YTD           2,296      354
                       P4 - 1 Year       66,998    5,188
01-Feb-2019 PROD_ONE   P1 - 1 Month       6,197      942
                       P2 - 3 Months     17,476    1,602
                       P3 - YTD          13,750    1,068
                       P4 - 1 Year       62,611    6,033
            PROD_TWO   P1 - 1 Month       6,100      377
                       P2 - 3 Months     10,848    1,132
                       P3 - YTD           8,396      731
                       P4 - 1 Year       73,098    5,565
01-Mar-2019 PROD_ONE   P1 - 1 Month       9,794      520
                       P2 - 3 Months     23,544    1,588
                       P3 - YTD          23,544    1,588
                       P4 - 1 Year       65,957    6,236
            PROD_TWO   P1 - 1 Month       3,871      290
                       P2 - 3 Months     12,267    1,021
                       P3 - YTD          12,267    1,021
                       P4 - 1 Year       70,695    5,211
01-Apr-2019 PROD_ONE   P1 - 1 Month       5,995      639
                       P2 - 3 Months     21,986    2,101
                       P3 - YTD          29,539    2,227
                       P4 - 1 Year       67,681    6,463
            PROD_TWO   P1 - 1 Month       4,622      572
                       P2 - 3 Months     14,593    1,239
                       P3 - YTD          16,889    1,593
                       P4 - 1 Year       69,786    5,296
01-May-2019 PROD_ONE   P1 - 1 Month       6,469      189
                       P2 - 3 Months     22,258    1,348
                       P3 - YTD          36,008    2,416
                       P4 - 1 Year       70,562    6,059
            PROD_TWO   P1 - 1 Month       6,094      276
                       P2 - 3 Months     14,587    1,138
                       P3 - YTD          22,983    1,869
                       P4 - 1 Year       67,592    5,168
01-Jun-2019 PROD_ONE   P1 - 1 Month       9,212      620
                       P2 - 3 Months     21,676    1,448
                       P3 - YTD          45,220    3,036
                       P4 - 1 Year       77,153    6,215
            PROD_TWO   P1 - 1 Month       1,945      604
                       P2 - 3 Months     12,661    1,452
                       P3 - YTD          24,928    2,473
                       P4 - 1 Year       61,691    4,816
01-Jul-2019 PROD_ONE   P1 - 1 Month       4,226      820
                       P2 - 3 Months     19,907    1,629
                       P3 - YTD          49,446    3,856
                       P4 - 1 Year       78,892    6,511
            PROD_TWO   P1 - 1 Month       1,215      455
                       P2 - 3 Months      9,254    1,335
                       P3 - YTD          26,143    2,928
                       P4 - 1 Year       53,930    4,770
01-Aug-2019 PROD_ONE   P1 - 1 Month       8,625      340
                       P2 - 3 Months     22,063    1,780
                       P3 - YTD          58,071    4,196
                       P4 - 1 Year       77,601    6,172
            PROD_TWO   P1 - 1 Month       5,260      293
                       P2 - 3 Months      8,420    1,352
                       P3 - YTD          31,403    3,221
                       P4 - 1 Year       52,409    4,952
01-Sep-2019 PROD_ONE   P1 - 1 Month       7,185      146
                       P2 - 3 Months     20,036    1,306
                       P3 - YTD          65,256    4,342
                       P4 - 1 Year       77,545    5,523
            PROD_TWO   P1 - 1 Month       1,798      220
                       P2 - 3 Months      8,273      968
                       P3 - YTD          33,201    3,441
                       P4 - 1 Year       45,560    4,815
01-Oct-2019 PROD_ONE   P1 - 1 Month       3,698      139
                       P2 - 3 Months     19,508      625
                       P3 - YTD          68,954    4,481
                       P4 - 1 Year       75,876    5,209
            PROD_TWO   P1 - 1 Month       5,801      635
                       P2 - 3 Months     12,859    1,148
                       P3 - YTD          39,002    4,076
                       P4 - 1 Year       48,921    5,290
01-Nov-2019 PROD_ONE   P1 - 1 Month       1,325      533
                       P2 - 3 Months     12,208      818
                       P3 - YTD          70,279    5,014
                       P4 - 1 Year       74,005    5,548
            PROD_TWO   P1 - 1 Month       4,278      629
                       P2 - 3 Months     11,877    1,484
                       P3 - YTD          43,280    4,705
                       P4 - 1 Year       45,732    5,106
01-Dec-2019 PROD_ONE   P1 - 1 Month       3,717      120
                       P2 - 3 Months      8,740      792
                       P3 - YTD          73,996    5,134
                       P4 - 1 Year       73,996    5,134
            PROD_TWO   P1 - 1 Month       9,163      547
                       P2 - 3 Months     19,242    1,811
                       P3 - YTD          52,443    5,252
                       P4 - 1 Year       52,443    5,252
01-Jan-2020 PROD_ONE   P1 - 1 Month       7,315      803
                       P2 - 3 Months     12,357    1,456
                       P3 - YTD           7,315      803
                       P4 - 1 Year       73,758    5,811
            PROD_TWO   P1 - 1 Month       4,399      228
                       P2 - 3 Months     17,840    1,404
                       P3 - YTD           4,399      228
                       P4 - 1 Year       54,546    5,126
01-Feb-2020 PROD_ONE   P1 - 1 Month       7,846      842
                       P2 - 3 Months     18,878    1,765
                       P3 - YTD          15,161    1,645
                       P4 - 1 Year       75,407    5,711
            PROD_TWO   P1 - 1 Month       6,310      991
                       P2 - 3 Months     19,872    1,766
                       P3 - YTD          10,709    1,219
                       P4 - 1 Year       54,756    5,740
01-Mar-2020 PROD_ONE   P1 - 1 Month       9,766      477
                       P2 - 3 Months     24,927    2,122
                       P3 - YTD          24,927    2,122
                       P4 - 1 Year       75,379    5,668
            PROD_TWO   P1 - 1 Month       6,675      163
                       P2 - 3 Months     17,384    1,382
                       P3 - YTD          17,384    1,382
                       P4 - 1 Year       57,560    5,613
01-Apr-2020 PROD_ONE   P1 - 1 Month       9,017      139
                       P2 - 3 Months     26,629    1,458
                       P3 - YTD          33,944    2,261
                       P4 - 1 Year       78,401    5,168
            PROD_TWO   P1 - 1 Month       7,437      971
                       P2 - 3 Months     20,422    2,125
                       P3 - YTD          24,821    2,353
                       P4 - 1 Year       60,375    6,012
01-May-2020 PROD_ONE   P1 - 1 Month       4,638      776
                       P2 - 3 Months     23,421    1,392
                       P3 - YTD          38,582    3,037
                       P4 - 1 Year       76,570    5,755
            PROD_TWO   P1 - 1 Month       1,603      101
                       P2 - 3 Months     15,715    1,235
                       P3 - YTD          26,424    2,454
                       P4 - 1 Year       55,884    5,837
01-Jun-2020 PROD_ONE   P1 - 1 Month       4,353      624
                       P2 - 3 Months     18,008    1,539
                       P3 - YTD          42,935    3,661
                       P4 - 1 Year       71,711    5,759
            PROD_TWO   P1 - 1 Month       6,288      915
                       P2 - 3 Months     15,328    1,987
                       P3 - YTD          32,712    3,369
                       P4 - 1 Year       60,227    6,148
01-Jul-2020 PROD_ONE   P1 - 1 Month       7,372      927
                       P2 - 3 Months     16,363    2,327
                       P3 - YTD          50,307    4,588
                       P4 - 1 Year       74,857    5,866
            PROD_TWO   P1 - 1 Month       8,342      915
                       P2 - 3 Months     16,233    1,931
                       P3 - YTD          41,054    4,284
                       P4 - 1 Year       67,354    6,608
01-Aug-2020 PROD_ONE   P1 - 1 Month       9,509      906
                       P2 - 3 Months     21,234    2,457
                       P3 - YTD          59,816    5,494
                       P4 - 1 Year       75,741    6,432
            PROD_TWO   P1 - 1 Month       9,594      438
                       P2 - 3 Months     24,224    2,268
                       P3 - YTD          50,648    4,722
                       P4 - 1 Year       71,688    6,753
01-Sep-2020 PROD_ONE   P1 - 1 Month       6,826      183
                       P2 - 3 Months     23,707    2,016
                       P3 - YTD          66,642    5,677
                       P4 - 1 Year       75,382    6,469
            PROD_TWO   P1 - 1 Month       5,802      879
                       P2 - 3 Months     23,738    2,232
                       P3 - YTD          56,450    5,601
                       P4 - 1 Year       75,692    7,412
01-Oct-2020 PROD_ONE   P1 - 1 Month       9,841      571
                       P2 - 3 Months     26,176    1,660
                       P3 - YTD          76,483    6,248
                       P4 - 1 Year       81,525    6,901
            PROD_TWO   P1 - 1 Month       5,600      919
                       P2 - 3 Months     20,996    2,236
                       P3 - YTD          62,050    6,520
                       P4 - 1 Year       75,491    7,696
01-Nov-2020 PROD_ONE   P1 - 1 Month       3,442      854
                       P2 - 3 Months     20,109    1,608
                       P3 - YTD          79,925    7,102
                       P4 - 1 Year       83,642    7,222
            PROD_TWO   P1 - 1 Month       8,560      204
                       P2 - 3 Months     19,962    2,002
                       P3 - YTD          70,610    6,724
                       P4 - 1 Year       79,773    7,271
01-Dec-2020 PROD_ONE   P1 - 1 Month       9,182      443
                       P2 - 3 Months     22,465    1,868
                       P3 - YTD          89,107    7,545
                       P4 - 1 Year       89,107    7,545
            PROD_TWO   P1 - 1 Month       3,032      945
                       P2 - 3 Months     17,192    2,068
                       P3 - YTD          73,642    7,669
                       P4 - 1 Year       73,642    7,669
01-Jan-2021 PROD_ONE   P1 - 1 Month       8,410      806
                       P2 - 3 Months     21,034    2,103
                       P3 - YTD           8,410      806
                       P4 - 1 Year       90,202    7,548
            PROD_TWO   P1 - 1 Month       4,764      724
                       P2 - 3 Months     16,356    1,873
                       P3 - YTD           4,764      724
                       P4 - 1 Year       74,007    8,165
01-Feb-2021 PROD_ONE   P1 - 1 Month       4,914      352
                       P2 - 3 Months     22,506    1,601
                       P3 - YTD          13,324    1,158
                       P4 - 1 Year       87,270    7,058
            PROD_TWO   P1 - 1 Month       6,945      175
                       P2 - 3 Months     14,741    1,844
                       P3 - YTD          11,709      899
                       P4 - 1 Year       74,642    7,349

288 rows selected.

  1  WITH period_list AS (
  2  	SELECT month_dt, prod_code, COLUMN_VALUE per_tp
  3  	  FROM TABLE(SYS.ODCIVarchar2List(
  4  					'P1 - 1 Month',
  5  					'P2 - 3 Months',
  6  					'P3 - YTD',
  7  					'P4 - 1 Year')
  8  			)
  9  	CROSS JOIN (SELECT month_dt, prod_code FROM sales_history)
 10  )
 11  SELECT /*+ gather_plan_statistics XPLAN_MARKER_GBC */
 12         drv.month_dt, drv.prod_code, drv.per_tp,
 13         Sum( CASE WHEN ( per_tp = 'P1 - 1 Month'  AND msr.month_dt = drv.month_dt ) OR
 14                        ( per_tp = 'P2 - 3 Months' AND msr.month_dt >= Add_Months (drv.month_dt, -2) ) OR
 15                        ( per_tp = 'P3 - YTD'      AND Trunc (msr.month_dt, 'YEAR') = Trunc (drv.month_dt, 'YEAR') ) OR
 16                        ( per_tp = 'P4 - 1 Year'   AND msr.month_dt >= Add_Months (drv.month_dt, -11) )
 17                   THEN msr.sales_value END) sales_value,
 18         Sum( CASE WHEN ( per_tp = 'P1 - 1 Month'  AND msr.month_dt = drv.month_dt ) OR
 19                        ( per_tp = 'P2 - 3 Months' AND msr.month_dt >= Add_Months (drv.month_dt, -2) ) OR
 20                        ( per_tp = 'P3 - YTD'      AND Trunc (msr.month_dt, 'YEAR') = Trunc (drv.month_dt, 'YEAR') ) OR
 21                        ( per_tp = 'P4 - 1 Year'   AND msr.month_dt >= Add_Months (drv.month_dt, -11) )
 22                   THEN msr.sales_cost END) sales_cost
 23    FROM period_list drv
 24    JOIN sales_history msr
 25  	ON msr.prod_code = drv.prod_code
 26     AND msr.month_dt <= drv.month_dt
 27   GROUP BY drv.prod_code, drv.month_dt, drv.per_tp
 28*  ORDER BY 1, 2, 3
SQL_ID  c8rrwswsytdrk, child number 0
-------------------------------------
SELECT /*+ gather_plan_statistics XPLAN_MARKER_UGB */     month_dt,
prod_code, 'P1 - 1 Month' per_tp, sales_value, sales_cost   FROM
sales_history  UNION ALL SELECT drv.month_dt, drv.prod_code, 'P2 - 3
Months', Sum(msr.sales_value), Sum(msr.sales_cost)   FROM sales_history
drv   JOIN sales_history msr  ON msr.prod_code = drv.prod_code    AND
msr.month_dt BETWEEN Add_Months (drv.month_dt, -2) AND drv.month_dt
GROUP BY drv.prod_code, drv.month_dt  UNION ALL SELECT drv.month_dt,
drv.prod_code, 'P3 - YTD', Sum(msr.sales_value), Sum(msr.sales_cost)
FROM sales_history drv   JOIN sales_history msr  ON msr.prod_code =
drv.prod_code    AND msr.month_dt BETWEEN Trunc(drv.month_dt, 'YEAR')
AND drv.month_dt  GROUP BY drv.prod_code, drv.month_dt  UNION ALL
SELECT drv.month_dt, drv.prod_code, 'P4 - 1 Year',
Sum(msr.sales_value), Sum(msr.sales_cost)   FROM sales_history drv
JOIN sales_history msr  ON msr.prod_code = drv.prod_code    AND
msr.month_dt BETWEEN Add_Months (drv.month_dt, -11) AND drv
Plan hash value: 3154844439
----------------------------------------------------------------------------------------------------------------------------
| Id  | Operation             | Name          | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
----------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT      |               |      1 |        |    288 |00:00:00.01 |      27 |       |       |          |
|   1 |  SORT ORDER BY        |               |      1 |    225 |    288 |00:00:00.01 |      27 | 27648 | 27648 |24576  (0)|
|   2 |   UNION-ALL           |               |      1 |        |    288 |00:00:00.01 |      27 |       |       |          |
|   3 |    TABLE ACCESS FULL  | SALES_HISTORY |      1 |     72 |     72 |00:00:00.01 |       6 |       |       |          |
|   4 |    HASH GROUP BY      |               |      1 |     51 |     72 |00:00:00.01 |       7 |   934K|   934K| 1394K (0)|
|*  5 |     HASH JOIN         |               |      1 |     67 |    210 |00:00:00.01 |       7 |  1506K|  1506K|  830K (0)|
|   6 |      INDEX FULL SCAN  | SLH_PK        |      1 |     72 |     72 |00:00:00.01 |       1 |       |       |          |
|   7 |      TABLE ACCESS FULL| SALES_HISTORY |      1 |     72 |     72 |00:00:00.01 |       6 |       |       |          |
|   8 |    HASH GROUP BY      |               |      1 |     51 |     72 |00:00:00.01 |       7 |   934K|   934K| 1387K (0)|
|*  9 |     HASH JOIN         |               |      1 |     67 |    428 |00:00:00.01 |       7 |  1506K|  1506K|  832K (0)|
|  10 |      INDEX FULL SCAN  | SLH_PK        |      1 |     72 |     72 |00:00:00.01 |       1 |       |       |          |
|  11 |      TABLE ACCESS FULL| SALES_HISTORY |      1 |     72 |     72 |00:00:00.01 |       6 |       |       |          |
|  12 |    HASH GROUP BY      |               |      1 |     51 |     72 |00:00:00.01 |       7 |   934K|   934K| 1387K (0)|
|* 13 |     HASH JOIN         |               |      1 |     67 |    732 |00:00:00.01 |       7 |  1506K|  1506K|  829K (0)|
|  14 |      INDEX FULL SCAN  | SLH_PK        |      1 |     72 |     72 |00:00:00.01 |       1 |       |       |          |
|  15 |      TABLE ACCESS FULL| SALES_HISTORY |      1 |     72 |     72 |00:00:00.01 |       6 |       |       |          |
----------------------------------------------------------------------------------------------------------------------------
Predicate Information (identified by operation id):
---------------------------------------------------
5 - access("MSR"."PROD_CODE"="DRV"."PROD_CODE")
filter(("MSR"."MONTH_DT"<="DRV"."MONTH_DT" AND "MSR"."MONTH_DT">=ADD_MONTHS(INTERNAL_FUNCTION("DRV"."MONTH_DT
"),-2)))
9 - access("MSR"."PROD_CODE"="DRV"."PROD_CODE")
filter(("MSR"."MONTH_DT"<="DRV"."MONTH_DT" AND "MSR"."MONTH_DT">=TRUNC(INTERNAL_FUNCTION("DRV"."MONTH_DT"),'f
myear')))
13 - access("MSR"."PROD_CODE"="DRV"."PROD_CODE")
filter(("MSR"."MONTH_DT"<="DRV"."MONTH_DT" AND "MSR"."MONTH_DT">=ADD_MONTHS(INTERNAL_FUNCTION("DRV"."MONTH_DT
"),-11)))

PL/SQL procedure successfully completed.

SQL_ID  gg5kj6w47045n, child number 0
-------------------------------------
WITH period_aggs AS (  SELECT /*+ gather_plan_statistics
XPLAN_MARKER_AAG */      month_dt, prod_code, sales_value,
Sum(sales_value) OVER (PARTITION BY prod_code ORDER BY month_dt
RANGE BETWEEN INTERVAL '2' MONTH PRECEDING AND CURRENT ROW)
sales_value_3m,      Sum(sales_value) OVER (PARTITION BY prod_code,
Trunc(month_dt, 'YEAR') ORDER BY month_dt           RANGE BETWEEN
INTERVAL '11' MONTH PRECEDING AND CURRENT ROW)   sales_value_ytd,
Sum(sales_value) OVER (PARTITION BY prod_code ORDER BY month_dt
RANGE BETWEEN INTERVAL '11' MONTH PRECEDING AND CURRENT ROW)
sales_value_1y,      sales_cost,      Sum(sales_cost) OVER (PARTITION
BY prod_code ORDER BY month_dt           RANGE BETWEEN INTERVAL '2'
MONTH PRECEDING AND CURRENT ROW)   sales_cost_3m,      Sum(sales_cost)
OVER (PARTITION BY prod_code, Trunc(month_dt, 'YEAR') ORDER BY month_dt
RANGE BETWEEN INTERVAL '11' MONTH PRECEDING AND CURRENT ROW)
sales_cost_ytd,      Sum(sales_cost) OVER (PART
Plan hash value: 1117112452
----------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                         | Name          | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
----------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                  |               |      1 |        |    288 |00:00:00.01 |       2 |       |       |          |
|   1 |  SORT ORDER BY                    |               |      1 |    288 |    288 |00:00:00.01 |       2 | 27648 | 27648 |24576  (0)|
|*  2 |   VIEW                            |               |      1 |    288 |    288 |00:00:00.01 |       2 |       |       |          |
|   3 |    UNPIVOT                        |               |      1 |        |    288 |00:00:00.01 |       2 |       |       |          |
|   4 |     VIEW                          |               |      1 |     72 |     72 |00:00:00.01 |       2 |       |       |          |
|   5 |      WINDOW SORT                  |               |      1 |     72 |     72 |00:00:00.01 |       2 | 13312 | 13312 |12288  (0)|
|   6 |       WINDOW BUFFER               |               |      1 |     72 |     72 |00:00:00.01 |       2 |  6144 |  6144 | 6144  (0)|
|   7 |        TABLE ACCESS BY INDEX ROWID| SALES_HISTORY |      1 |     72 |     72 |00:00:00.01 |       2 |       |       |          |
|   8 |         INDEX FULL SCAN           | SLH_PK        |      1 |     72 |     72 |00:00:00.01 |       1 |       |       |          |
----------------------------------------------------------------------------------------------------------------------------------------
Predicate Information (identified by operation id):
---------------------------------------------------
2 - filter(("unpivot_view_006"."SALES_VALUE" IS NOT NULL OR "unpivot_view_006"."SALES_COST" IS NOT NULL))

PL/SQL procedure successfully completed.

SQL_ID  a7ygrp0awsufa, child number 0
-------------------------------------
WITH period_list AS (  SELECT month_dt, prod_code, COLUMN_VALUE per_tp
FROM TABLE(SYS.ODCIVarchar2List(      'P1 - 1 Month',      'P2 - 3
Months',      'P3 - YTD',      'P4 - 1 Year')    )  CROSS JOIN (SELECT
month_dt, prod_code FROM sales_history) ) SELECT /*+
gather_plan_statistics XPLAN_MARKER_GBC */        drv.month_dt,
drv.prod_code, drv.per_tp,        Sum( CASE WHEN ( per_tp = 'P1 - 1
Month'  AND msr.month_dt = drv.month_dt ) OR                       (
per_tp = 'P2 - 3 Months' AND msr.month_dt >= Add_Months (drv.month_dt,
-2) ) OR                       ( per_tp = 'P3 - YTD'      AND Trunc
(msr.month_dt, 'YEAR') = Trunc (drv.month_dt, 'YEAR') ) OR
( per_tp = 'P4 - 1 Year'   AND msr.month_dt >= Add_Months
(drv.month_dt, -11) )                  THEN msr.sales_value END)
sales_value,        Sum( CASE WHEN ( per_tp = 'P1 - 1 Month'  AND
msr.month_dt = drv.month_dt ) OR                       ( per_tp = 'P2 -
3 Months' AND msr.month_dt >= Add_Months (drv.month_d
Plan hash value: 1337298906
------------------------------------------------------------------------------------------------------------------------------------------------
| Id  | Operation                                 | Name          | Starts | E-Rows | A-Rows |   A-Time   | Buffers |  OMem |  1Mem | Used-Mem |
------------------------------------------------------------------------------------------------------------------------------------------------
|   0 | SELECT STATEMENT                          |               |      1 |        |    288 |00:00:00.01 |       7 |       |       |          |
|   1 |  SORT GROUP BY                            |               |      1 |     51 |    288 |00:00:00.01 |       7 | 40960 | 40960 |36864  (0)|
|*  2 |   HASH JOIN                               |               |      1 |     10M|   5328 |00:00:00.01 |       7 |  1476K|  1476K|  892K (0)|
|   3 |    INDEX FULL SCAN                        | SLH_PK        |      1 |     72 |     72 |00:00:00.01 |       1 |       |       |          |
|   4 |    MERGE JOIN CARTESIAN                   |               |      1 |    588K|    288 |00:00:00.01 |       6 |       |       |          |
|   5 |     TABLE ACCESS FULL                     | SALES_HISTORY |      1 |     72 |     72 |00:00:00.01 |       6 |       |       |          |
|   6 |     BUFFER SORT                           |               |     72 |   8168 |    288 |00:00:00.01 |       0 |  2048 |  2048 | 2048  (0)|
|   7 |      COLLECTION ITERATOR CONSTRUCTOR FETCH|               |      1 |   8168 |      4 |00:00:00.01 |       0 |       |       |          |
------------------------------------------------------------------------------------------------------------------------------------------------
Predicate Information (identified by operation id):
---------------------------------------------------
2 - access("MSR"."PROD_CODE"="PROD_CODE")
filter("MSR"."MONTH_DT"<="MONTH_DT")

PL/SQL procedure successfully completed.


'END:'||TO_CHAR(SYSDATE,'DD-MON-YY
----------------------------------
End: 28-FEB-2021 14:16:27

